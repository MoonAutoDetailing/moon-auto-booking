<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Auto Detailing – Book Now</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root{
      --moon-blue:#4f8de6;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#d6dbe3;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);

      /* Higher-contrast blocked overlay */
      --blocked-red: rgba(220, 38, 38, 0.30);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .topbar{
      background:#0b0b0b;
      height:70px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding:0 18px;
    }
    .topbar img{ height:44px; }
    .wrap{ padding:34px 16px 60px; }
    .card{
      max-width:560px;
      margin:0 auto;
      background:#fff;
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:28px;
    }
    h1{
      text-align:center;
      color:var(--moon-blue);
      font-size:42px;
      margin-bottom:22px;
    }
    label{
      font-weight:700;
      display:block;
      margin:16px 0 8px;
    }
    input, select{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:15px;
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .btn{
      margin-top:22px;
      padding:14px;
      border-radius:12px;
      border:none;
      background:var(--moon-blue);
      color:#fff;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .status{
      margin-top:14px;
      font-size:14px;
      color:var(--muted);
      white-space:pre-wrap;
    }
    #calendar{
      margin-top:8px;
      border-radius:12px;
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .hint{
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.3;
    }
    @media (max-width:520px){
      .row{ grid-template-columns:1fr; }
      h1{ font-size:34px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <img src="NewLogoColor.png" alt="Moon Auto Detailing" />
  </div>

  <div class="wrap">
    <div class="card">
      <h1>Book a Detail</h1>

      <form id="booking-form">
        <label>Full Name</label>
        <input id="fullName" required />

        <label>Email</label>
        <input id="email" type="email" required />

        <label>Phone</label>
        <input id="phone" required />

        <label>Service Address</label>
        <input id="address" required />

        <div class="row">
          <div>
            <label>Vehicle Year</label>
            <input id="vehicleYear" type="number" required />
          </div>
          <div>
            <label>License Plate</label>
            <input id="licensePlate" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Vehicle Make</label>
            <input id="vehicleMake" required />
          </div>
          <div>
            <label>Vehicle Model</label>
            <input id="vehicleModel" required />
          </div>
        </div>

        <label>Vehicle Size</label>
        <select id="vehicleSize" required>
          <option value="">Select size</option>
          <option value="compact">compact</option>
          <option value="midsized">midsized</option>
          <option value="oversized">oversized</option>
        </select>

        <label>Select Service</label>
        <select id="serviceSelect" disabled required>
          <option value="">Select vehicle size first</option>
        </select>

        <label>Pick a Time (8am–5pm)</label>
        <div id="calendar"></div>
        <div class="hint" id="timeHint">Select a service first to enable time selection.</div>

        <!-- Hidden fields used by booking pipeline -->
        <input type="hidden" id="startTime" />
        <input type="hidden" id="endTime" />

        <button class="btn">Submit Booking</button>
        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

<script>
/* ======================
   SUPABASE CLIENT
   ====================== */
const supabaseClient = supabase.createClient(
  "https://lhwlvleocakggpbbpzyx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmJhenl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTQwMDksImV4cCI6MjA4NjAzMDAwOX0.VXGGO7KCqWmcpXOFrlpPT92WmZMxe8xpNNytAsdjURI"
);

const vehicleSizeEl = document.getElementById("vehicleSize");
const serviceSelectEl = document.getElementById("serviceSelect");
const statusEl = document.getElementById("status");
const timeHintEl = document.getElementById("timeHint");

let calendar = null;
let selectedDurationMinutes = null;
let blockedRanges = []; // [{start: Date, end: Date}] for current view

/* ======================
   LOAD SERVICES (REVERTED TO YOUR WORKING LOGIC)
   ====================== */
vehicleSizeEl.addEventListener("change", loadServices);

async function loadServices() {
  serviceSelectEl.disabled = true;
  serviceSelectEl.innerHTML = "";
  selectedDurationMinutes = null;
  document.getElementById("startTime").value = "";
  document.getElementById("endTime").value = "";
  timeHintEl.textContent = "Select a service first to enable time selection.";

  const size = vehicleSizeEl.value;
  if (!size) {
    serviceSelectEl.innerHTML = `<option value="">Select vehicle size first</option>`;
    return;
  }

  const { data, error } = await supabaseClient
    .from("service_variants")
    .select(`
      id, price, duration_minutes,
      services:service_id ( category, level )
    `)
    .eq("vehicle_size", size)
    .eq("active", true);

  if (error) {
    console.error("loadServices error:", error);
    serviceSelectEl.innerHTML = `<option value="">Error loading services</option>`;
    return;
  }

  serviceSelectEl.innerHTML = `<option value="">Select service</option>`;
  data.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.dataset.duration = String(r.duration_minutes);
    opt.textContent = `${r.services.category} – Level ${r.services.level} ($${r.price}) • ${r.duration_minutes} min`;
    serviceSelectEl.appendChild(opt);
  });

  serviceSelectEl.disabled = false;
}

/* ======================
   CALENDAR (SAFE MODULE)
   - will never break service dropdown
   ====================== */
function ensureCalendar() {
  if (calendar) return;

  const calEl = document.getElementById("calendar");
  calendar = new FullCalendar.Calendar(calEl, {
    initialView: "timeGridWeek",
    height: "auto",
    allDaySlot: false,
    nowIndicator: true,
    slotDuration: "00:15:00",

    // Show business hours only (reduces page height)
    slotMinTime: "08:00:00",
    slotMaxTime: "17:00:00",

    selectable: true, // we will validate clicks ourselves
    selectMirror: false,

    // We will load blocked ranges on view change
    datesSet: async (info) => {
      await loadBlockedRanges(info.start, info.end);
      // re-render background blocks
      calendar.removeAllEvents();
      blockedRanges.forEach(r => {
        calendar.addEvent({
          start: r.start,
          end: r.end,
          display: "background",
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue("--blocked-red").trim() || "rgba(220,38,38,0.30)"
        });
      });
    },

    // Click a time slot to choose start time
    dateClick: (info) => {
      // Must have service duration selected
      if (!selectedDurationMinutes) {
        statusEl.textContent = "Select a service first, then pick a time.";
        return;
      }

      const start = info.date;
      const end = new Date(start.getTime() + selectedDurationMinutes * 60000);

      // Enforce business window 8–5 based on chosen start/end
      if (!withinBusinessHours(start, end)) {
        statusEl.textContent = "Pick a time between 8:00 AM and 5:00 PM that fits the service duration.";
        return;
      }

      // Must not overlap any blocked booking ranges
      if (overlapsBlocked(start, end)) {
        statusEl.textContent = "That time is not available. Pick another slot.";
        return;
      }

      // Save into hidden inputs (booking pipeline unchanged)
      document.getElementById("startTime").value = start.toISOString();
      document.getElementById("endTime").value = end.toISOString();

      timeHintEl.textContent = `Selected: ${start.toLocaleString()} → ${end.toLocaleString()}`;
      statusEl.textContent = "";
    }
  });

  calendar.render();
}

async function loadBlockedRanges(viewStart, viewEnd) {
  try {
    const { data, error } = await supabaseClient.rpc("get_public_unavailable_ranges", {
      p_start: viewStart.toISOString(),
      p_end: viewEnd.toISOString()
    });
    if (error) {
      console.error("availability rpc error:", error);
      blockedRanges = [];
      return;
    }
    blockedRanges = (data || []).map(r => ({
      start: new Date(r.unavailable_start),
      end: new Date(r.unavailable_end)
    }));
  } catch (e) {
    console.error("loadBlockedRanges fatal:", e);
    blockedRanges = [];
  }
}

function overlapsBlocked(start, end) {
  return blockedRanges.some(r => (start < r.end) && (end > r.start));
}

function withinBusinessHours(start, end) {
  const startH = start.getHours() + start.getMinutes() / 60;
  const endH = end.getHours() + end.getMinutes() / 60;

  // Must start at/after 8:00 and end at/before 17:00
  return startH >= 8 && endH <= 17;
}

/* When service changes, store duration and enable time picking */
serviceSelectEl.addEventListener("change", () => {
  const opt = serviceSelectEl.selectedOptions[0];
  selectedDurationMinutes = opt && opt.dataset.duration ? Number(opt.dataset.duration) : null;

  document.getElementById("startTime").value = "";
  document.getElementById("endTime").value = "";

  if (!selectedDurationMinutes) {
    timeHintEl.textContent = "Select a service first to enable time selection.";
    return;
  }

  timeHintEl.textContent = "Click an available time slot to select your appointment.";
  ensureCalendar();
});

/* ======================
   BOOKING SUBMIT (SAME FLOW, ADDS ONLY OVERLAP ERROR HANDLING)
   ====================== */
document.getElementById("booking-form").addEventListener("submit", async e => {
  e.preventDefault();

  const startIso = document.getElementById("startTime").value;
  const endIso = document.getElementById("endTime").value;

  if (!startIso || !endIso) {
    statusEl.textContent = "Please select a time on the calendar.";
    return;
  }

  statusEl.textContent = "Submitting…";

  const email = document.getElementById("email").value.trim().toLowerCase();

  const { data: cust, error: custErr } = await supabaseClient
    .from("customers")
    .select("id")
    .eq("email", email)
    .limit(1);

  if (custErr) {
    statusEl.textContent = custErr.message;
    return;
  }

  let customerId;
  if (cust && cust.length) customerId = cust[0].id;
  else {
    const { data, error } = await supabaseClient.from("customers").insert([{
      full_name: fullName.value,
      email,
      phone: phone.value,
      address: address.value
    }]);

    if (error) {
      statusEl.textContent = error.message;
      return;
    }
    // keep behavior consistent with your current pipeline
    customerId = data?.[0]?.id;
  }

  const vehicleId = crypto.randomUUID();

  const { error: vehErr } = await supabaseClient.from("vehicles").insert([{
    id: vehicleId,
    customer_id: customerId,
    vehicle_size: vehicleSize.value,
    license_plate: licensePlate.value,
    vehicle_year: Number(vehicleYear.value),
    vehicle_make: vehicleMake.value,
    vehicle_model: vehicleModel.value
  }]);

  if (vehErr) {
    statusEl.textContent = vehErr.message;
    return;
  }

  const { error: bookErr } = await supabaseClient.from("bookings").insert([{
    customer_id: customerId,
    vehicle_id: vehicleId,
    service_variant_id: serviceSelectEl.value,
    service_address: address.value,
    scheduled_start: startIso,
    scheduled_end: endIso,
    status: "pending"
  }]);

  if (bookErr) {
    // overlap enforcement constraint error code
    if (bookErr.code === "23P01") {
      statusEl.textContent = "That time slot was just taken. Please pick another.";
      // refresh blocks so UI matches reality
      if (calendar) calendar.refetchEvents?.();
    } else {
      statusEl.textContent = bookErr.message;
    }
    return;
  }

  statusEl.textContent = "✅ Booking submitted successfully.";
});
</script>
</body>
</html>
