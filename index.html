<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Auto Detailing – Book Now</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- FullCalendar (ADD) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root{
      --moon-blue:#4f8de6;
      --moon-blue-dark:#3e7bd6;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#d6dbe3;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .topbar{
      background:#0b0b0b;
      height:70px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding:0 18px;
    }
    .topbar img{ height:44px; }
    .wrap{ padding:34px 16px 60px; }
    .card{
      max-width:560px;
      margin:0 auto;
      background:#fff;
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:28px;
    }
    h1{
      text-align:center;
      color:var(--moon-blue);
      font-size:42px;
      margin-bottom:22px;
    }
    label{
      font-weight:700;
      display:block;
      margin:16px 0 8px;
    }
    input, select{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:15px;
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .btn{
      margin-top:22px;
      padding:14px;
      border-radius:12px;
      border:none;
      background:var(--moon-blue);
      color:#fff;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .status{
      margin-top:14px;
      font-size:14px;
      color:var(--muted);
      white-space:pre-wrap;
    }
    @media (max-width:520px){
      .row{ grid-template-columns:1fr; }
      h1{ font-size:34px; }
    }

    /* ===== Calendar UI (ADD) ===== */
    .calendarWrap{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    #calendarLockMsg{
      padding:12px;
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
      border-radius:12px;
      margin-top:10px;
      font-size:14px;
    }
    /* hidden until service selected */
    .hidden{ display:none; }
  </style>
</head>

<body>
  <div class="topbar">
    <img src="NewLogoColor.png" alt="Moon Auto Detailing" />
  </div>

  <div class="wrap">
    <div class="card">
      <h1>Book a Detail</h1>

      <form id="booking-form">
        <label>Full Name</label>
        <input id="fullName" required />

        <label>Email</label>
        <input id="email" type="email" required />

        <label>Phone</label>
        <input id="phone" required />

        <label>Service Address</label>
        <input id="address" required />

        <div class="row">
          <div>
            <label>Vehicle Year</label>
            <input id="vehicleYear" type="number" required />
          </div>
          <div>
            <label>License Plate</label>
            <input id="licensePlate" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Vehicle Make</label>
            <input id="vehicleMake" required />
          </div>
          <div>
            <label>Vehicle Model</label>
            <input id="vehicleModel" required />
          </div>
        </div>

        <label>Vehicle Size</label>
        <select id="vehicleSize" required>
          <option value="">Select size</option>
          <option value="compact">compact</option>
          <option value="midsized">midsized</option>
          <option value="oversized">oversized</option>
        </select>

        <label>Select Service</label>
        <select id="serviceSelect" disabled required>
          <option value="">Select vehicle size first</option>
        </select>

        <!-- ===== Start/End remain present (original) ===== -->
        <label>Start</label>
        <input id="startTime" type="datetime-local" required />

        <label>End</label>
        <input id="endTime" type="datetime-local" required />

        <!-- ===== Calendar (ADD) ===== -->
        <label>Availability Calendar</label>

        <!-- locked message (visible until service selected) -->
        <div id="calendarLockMsg">Select a service to view available times.</div>

        <!-- calendar hidden until service selected -->
        <div id="calendarContainer" class="calendarWrap hidden">
          <div id="calendar"></div>
        </div>

        <button class="btn">Submit Booking</button>
        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

<script>
/* ================= ORIGINAL WORKING SUPABASE + DROPDOWN ================= */

const supabaseClient = supabase.createClient(
  "https://lhwlvleocakggpbbpzyx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxod2x2bGVvY2FrZ2dwYmJwenl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTQwMDksImV4cCI6MjA4NjAzMDAwOX0.VXGGO7KCqWmcpXOFrlpPT92WmZMxe8xpNNytAsdjURI"
);

const vehicleSizeEl = document.getElementById("vehicleSize");
const serviceSelectEl = document.getElementById("serviceSelect");
const statusEl = document.getElementById("status");

vehicleSizeEl.addEventListener("change", loadServices);

/* DO NOT CHANGE DROPDOWN LOGIC */
async function loadServices() {
  serviceSelectEl.disabled = true;
  serviceSelectEl.innerHTML = "";
  const size = vehicleSizeEl.value;
  if (!size) return;

  const { data } = await supabaseClient
    .from("service_variants")
    .select(`
      id, price, duration_minutes,
      services:service_id ( category, level )
    `)
    .eq("vehicle_size", size)
    .eq("active", true);

  serviceSelectEl.innerHTML = `<option value="">Select service</option>`;
  data.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = `${r.services.category} – Level ${r.services.level} ($${r.price})`;
    serviceSelectEl.appendChild(opt);
  });
  serviceSelectEl.disabled = false;
}

/* ================= ONLY ADDITION: calendar lock/unlock ================= */

const calendarLockMsg = document.getElementById("calendarLockMsg");
const calendarContainer = document.getElementById("calendarContainer");

let calendarInitialized = false;
let calendar;

serviceSelectEl.addEventListener("change", () => {
  // if no service selected, keep locked
  if (!serviceSelectEl.value) {
    calendarContainer.classList.add("hidden");
    calendarLockMsg.classList.remove("hidden");
    return;
  }

  // unlock calendar UI
  calendarLockMsg.classList.add("hidden");
  calendarContainer.classList.remove("hidden");

  // init once
  if (!calendarInitialized) {
    calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView: "timeGridWeek",
      allDaySlot: false,
      nowIndicator: true,
      height: "auto",
      slotMinTime: "08:00:00",
      slotMaxTime: "17:00:00",
      slotDuration: "00:15:00"
    });
    calendar.render();
    calendarInitialized = true;
  }
});

/* ================= ORIGINAL SUBMIT FLOW ================= */

document.getElementById("booking-form").addEventListener("submit", async e => {
  e.preventDefault();
  statusEl.textContent = "Submitting…";

  const email = document.getElementById("email").value.trim().toLowerCase();

  const { data: cust } = await supabaseClient
    .from("customers")
    .select("id")
    .eq("email", email)
    .limit(1);

  let customerId;
  if (cust.length) customerId = cust[0].id;
  else {
    const { data } = await supabaseClient.from("customers").insert([{
      full_name: fullName.value,
      email,
      phone: phone.value,
      address: address.value
    }]);
    customerId = data[0].id;
  }

  // ✅ FIXED PART — CLIENT UUID, NO SELECT
  const vehicleId = crypto.randomUUID();

  await supabaseClient.from("vehicles").insert([{
    id: vehicleId,
    customer_id: customerId,
    vehicle_size: vehicleSize.value,
    license_plate: licensePlate.value,
    vehicle_year: Number(vehicleYear.value),
    vehicle_make: vehicleMake.value,
    vehicle_model: vehicleModel.value
  }]);

  await supabaseClient.from("bookings").insert([{
    customer_id: customerId,
    vehicle_id: vehicleId,
    service_variant_id: serviceSelect.value,
    service_address: address.value,
    scheduled_start: startTime.value,
    scheduled_end: endTime.value,
    status: "pending"
  }]);

  statusEl.textContent = "✅ Booking submitted successfully.";
});
</script>
</body>
</html>
