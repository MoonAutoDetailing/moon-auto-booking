<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Auto Detailing – Book Now</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- FullCalendar (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root{
      --moon-blue:#4f8de6;
      --moon-blue-dark:#3e7bd6;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#d6dbe3;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .topbar{
      background:#0b0b0b;
      height:70px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding:0 18px;
    }
    .topbar img{ height:44px; }
    .wrap{ padding:34px 16px 60px; }
    .card{
      max-width:560px;
      margin:0 auto;
      background:#fff;
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:28px;
    }
    h1{
      text-align:center;
      color:var(--moon-blue);
      font-size:42px;
      margin-bottom:22px;
    }
    label{
      font-weight:700;
      display:block;
      margin:16px 0 8px;
    }
    input, select{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:15px;
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .btn{
      margin-top:22px;
      padding:14px;
      border-radius:12px;
      border:none;
      background:var(--moon-blue);
      color:#fff;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .status{
      margin-top:14px;
      font-size:14px;
      color:var(--muted);
      white-space:pre-wrap;
    }
    @media (max-width:520px){
      .row{ grid-template-columns:1fr; }
      h1{ font-size:34px; }
    }

    /* Calendar block */
    #calendarWrap{
      margin-top:18px;
      padding-top:10px;
      border-top:1px solid var(--border);
      display:none; /* hidden until service selected */
    }
    #calendarStatus{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
      white-space:pre-wrap;
    }

    /* Make "busy" blocks more visible (transparent red) */
    .fc .moon-busy {
      background: rgba(255, 0, 0, 0.22) !important;
      border-color: rgba(255, 0, 0, 0.35) !important;
    }

    /* Hide extra hours by config; this also increases contrast on grid */
    .fc .fc-timegrid-slot {
      border-color: rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <img src="NewLogoColor.png" alt="Moon Auto Detailing" />
  </div>

  <div class="wrap">
    <div class="card">
      <h1>Book a Detail</h1>

      <form id="booking-form">
        <label>Full Name</label>
        <input id="fullName" required />

        <label>Email</label>
        <input id="email" type="email" required />

        <label>Phone</label>
        <input id="phone" required />

        <label>Service Address</label>
        <input id="address" required />

        <div class="row">
          <div>
            <label>Vehicle Year</label>
            <input id="vehicleYear" type="number" required />
          </div>
          <div>
            <label>License Plate</label>
            <input id="licensePlate" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Vehicle Make</label>
            <input id="vehicleMake" required />
          </div>
          <div>
            <label>Vehicle Model</label>
            <input id="vehicleModel" required />
          </div>
        </div>

        <label>Vehicle Size</label>
        <select id="vehicleSize" required>
          <option value="">Select size</option>
          <option value="compact">compact</option>
          <option value="midsized">midsized</option>
          <option value="oversized">oversized</option>
        </select>

        <label>Select Service</label>
        <select id="serviceSelect" disabled required>
          <option value="">Select vehicle size first</option>
        </select>

        <!-- Keep your existing fields so the booking insert stays identical.
             We auto-fill these when the calendar time is clicked. -->
        <label>Start</label>
        <input id="startTime" type="datetime-local" required />

        <label>End</label>
        <input id="endTime" type="datetime-local" required />

        <!-- Calendar (hidden until service selected) -->
        <div id="calendarWrap">
          <label>Availability (click a time)</label>
          <div id="calendar"></div>
          <div id="calendarStatus"></div>
        </div>

        <button class="btn">Submit Booking</button>
        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

<script>
const supabaseClient = supabase.createClient(
  "https://lhwlvleocakggpbbpzyx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxod2x2bGVvY2FrZ2dwYmJwenl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTQwMDksImV4cCI6MjA4NjAzMDAwOX0.VXGGO7KCqWmcpXOFrlpPT92WmZMxe8xpNNytAsdjURI"
);

const vehicleSizeEl = document.getElementById("vehicleSize");
const serviceSelectEl = document.getElementById("serviceSelect");
const statusEl = document.getElementById("status");

const calendarWrapEl = document.getElementById("calendarWrap");
const calendarStatusEl = document.getElementById("calendarStatus");

let calendarInstance = null;
let selectedServiceDurationMins = null;
let busyRanges = []; // [{start: Date, end: Date}]

vehicleSizeEl.addEventListener("change", loadServices);
serviceSelectEl.addEventListener("change", onServiceSelected);

// Helper: datetime-local string (local time)
function toDatetimeLocalValue(d) {
  const pad = n => String(n).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// Helper: overlap check
function overlaps(startA, endA, startB, endB) {
  return startA < endB && endA > startB;
}

async function loadServices() {
  serviceSelectEl.disabled = true;
  serviceSelectEl.innerHTML = "";
  selectedServiceDurationMins = null;
  calendarWrapEl.style.display = "none";
  calendarStatusEl.textContent = "";
  if (calendarInstance) {
    calendarInstance.removeAllEvents();
  }

  const size = vehicleSizeEl.value;
  if (!size) return;

  // ONLY CHANGE vs your original: force an INNER join so r.services is never null.
  // Supabase supports !inner for nested relation filters. :contentReference[oaicite:3]{index=3}
  const { data, error } = await supabaseClient
  .from("service_variants")
  .select(`
    id,
    price,
    duration_minutes,
    services!service_variants_service_id_fkey (
      category,
      level
    )
  `)
  .eq("vehicle_size", size)
  .eq("active", true);



  if (error) {
    statusEl.textContent = "Error loading services: " + error.message;
    return;
  }

  serviceSelectEl.innerHTML = `<option value="">Select service</option>`;
  data.forEach(r => {
  if (!r.services) return; // ⬅️ skip broken FK rows

  const opt = document.createElement("option");
  opt.value = r.id;
  opt.textContent =
    `${r.services.category} – Level ${r.services.level} ($${r.price}) • ${r.duration_minutes} min`;
  opt.dataset.duration = String(r.duration_minutes);
  serviceSelectEl.appendChild(opt);
});

  serviceSelectEl.disabled = false;
}

async function onServiceSelected() {
  const selectedOpt = serviceSelectEl.options[serviceSelectEl.selectedIndex];
  const serviceId = serviceSelectEl.value;

  selectedServiceDurationMins = null;
  calendarWrapEl.style.display = "none";
  calendarStatusEl.textContent = "";

  if (!serviceId) return;

  // duration comes from the dropdown option dataset
  const dur = Number(selectedOpt.dataset.duration || "");
  if (!Number.isFinite(dur) || dur <= 0) {
    statusEl.textContent = "Service duration missing/invalid. Check service_variants.duration_minutes.";
    return;
  }
  selectedServiceDurationMins = dur;

  // Now (and only now) show calendar
  calendarWrapEl.style.display = "block";

  // Initialize calendar once
  if (!calendarInstance) {
    calendarInstance = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView: "timeGridWeek",
      nowIndicator: true,
      allDaySlot: false,

      // Only show business hours 8am–5pm. :contentReference[oaicite:4]{index=4}
      slotMinTime: "08:00:00",
      slotMaxTime: "17:00:00",
      slotDuration: "00:15:00",

      // allow clicking time slots (we use dateClick). :contentReference[oaicite:5]{index=5}
      selectable: true,

      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "timeGridWeek,timeGridDay"
      },

      // Load busy blocks when the visible range changes
      datesSet: async (info) => {
        await loadBusyBlocks(info.start, info.end);
      },

      dateClick: (info) => {
        if (!selectedServiceDurationMins) {
          calendarStatusEl.textContent = "Select a service first.";
          return;
        }

        const start = new Date(info.date);
        const end = new Date(start.getTime() + selectedServiceDurationMins * 60 * 1000);

        // Validate not overlapping with busy ranges
        for (const b of busyRanges) {
          if (overlaps(start, end, b.start, b.end)) {
            calendarStatusEl.textContent = "That time is not available. Pick a different slot.";
            return;
          }
        }

        // Set your existing fields (so booking insert remains unchanged)
        document.getElementById("startTime").value = toDatetimeLocalValue(start);
        document.getElementById("endTime").value = toDatetimeLocalValue(end);

        calendarStatusEl.textContent = `Selected: ${start.toLocaleString()} → ${end.toLocaleString()}`;
      }
    });

    calendarInstance.render();
  } else {
    // Re-fetch busy blocks for current view after service changes
    const view = calendarInstance.view;
    await loadBusyBlocks(view.activeStart, view.activeEnd);
  }
}

async function loadBusyBlocks(startDate, endDate) {
  calendarStatusEl.textContent = "Loading availability…";

  // Clear previous busy state
  busyRanges = [];
  if (calendarInstance) {
    // remove only busy events we added (className contains moon-busy)
    const existing = calendarInstance.getEvents();
    existing.forEach(ev => {
      if ((ev.classNames || []).includes("moon-busy")) ev.remove();
    });
  }

  // Call your PUBLIC RPC which returns busy ranges (start/end only).
  // We define it in the SQL section below.
  const { data, error } = await supabaseClient.rpc("get_public_busy_bookings", {
    p_start: startDate.toISOString(),
    p_end: endDate.toISOString()
  });

  if (error) {
    calendarStatusEl.textContent = "Availability error: " + error.message;
    return;
  }

  // Add busy blocks as background events (transparent red)
  data.forEach(r => {
    const s = new Date(r.scheduled_start);
    const e = new Date(r.scheduled_end);
    busyRanges.push({ start: s, end: e });

    if (calendarInstance) {
      calendarInstance.addEvent({
        start: r.scheduled_start,
        end: r.scheduled_end,
        display: "background",
        className: "moon-busy"
      });
    }
  });

  calendarStatusEl.textContent = "Click an available time to select it.";
}

document.getElementById("booking-form").addEventListener("submit", async e => {
  e.preventDefault();
  statusEl.textContent = "Submitting…";

  const email = document.getElementById("email").value.trim().toLowerCase();

  const { data: cust, error: custErr } = await supabaseClient
    .from("customers")
    .select("id")
    .eq("email", email)
    .limit(1);

  if (custErr) {
    statusEl.textContent = "Customer lookup error: " + custErr.message;
    return;
  }

  let customerId;
  if (cust.length) customerId = cust[0].id;
  else {
    const { data, error } = await supabaseClient.from("customers").insert([{
      full_name: fullName.value,
      email,
      phone: phone.value,
      address: address.value
    }]);

    if (error) {
      statusEl.textContent = "Customer insert error: " + error.message;
      return;
    }

    customerId = data[0].id;
  }

  // REQUIRED: client UUID, NO SELECT (kept)
  const vehicleId = crypto.randomUUID();

  const { error: vehErr } = await supabaseClient.from("vehicles").insert([{
    id: vehicleId,
    customer_id: customerId,
    vehicle_size: vehicleSize.value,
    license_plate: licensePlate.value,
    vehicle_year: Number(vehicleYear.value),
    vehicle_make: vehicleMake.value,
    vehicle_model: vehicleModel.value
  }]);

  if (vehErr) {
    statusEl.textContent = "Vehicle insert error: " + vehErr.message;
    return;
  }

  const { error: bookErr } = await supabaseClient.from("bookings").insert([{
    customer_id: customerId,
    vehicle_id: vehicleId,
    service_variant_id: serviceSelect.value,
    service_address: address.value,
    scheduled_start: startTime.value,
    scheduled_end: endTime.value,
    status: "pending"
  }]);

  if (bookErr) {
    statusEl.textContent = "Booking insert error: " + bookErr.message;
    return;
  }

  statusEl.textContent = "✅ Booking submitted successfully.";
});
</script>
</body>
</html>
