<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Auto Detailing – Booking</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; background:#f5f7fb; padding:40px; }
    .card { max-width:560px; margin:auto; background:#fff; padding:28px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
    h2 { text-align:center; color:#4a90e2; margin:0 0 18px; }
    label { display:block; margin-top:14px; font-weight:650; }
    input, select, button { width:100%; padding:10px 12px; margin-top:6px; border-radius:8px; border:1px solid #dcdcdc; font-size:14px; }
    button { margin-top:18px; background:#4a90e2; color:#fff; font-weight:750; border:none; cursor:pointer; }
    button.secondary { background:#111; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    pre { margin-top:14px; background:#0b1020; color:#d7e2ff; padding:12px; border-radius:10px; overflow:auto; font-size:12px; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
  </style>
</head>

<body>
  <div class="card">
    <h2>Book a Detail</h2>

    <label>Vehicle Size</label>
    <select id="vehicleSize" required>
      <option value="">Select size</option>
      <option value="compact">compact</option>
      <option value="midsized">midsized</option>
      <option value="oversized">oversized</option>
    </select>

    <div class="row">
      <button id="reloadBtn" class="secondary" type="button">Reload services</button>
      <button id="clearBtn" type="button">Clear</button>
    </div>

    <label>Select Service</label>
    <select id="serviceSelect" required>
      <option value="">Select vehicle size first</option>
    </select>

    <pre id="debug"></pre>
  </div>

<script>
  // ========= CONFIG =========
  const PROJECT_URL = "https://lhwlvleocakggpbbpzyx.supabase.co";
  const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxod2x2bGVvY2FrZ2dwYmJwenl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTQwMDksImV4cCI6MjA4NjAzMDAwOX0.VXGGO7KCqWmcpXOFrlpPT92WmZMxe8xpNNytAsdjURI";

  // ========= INIT =========
  const sb = window.supabase.createClient(PROJECT_URL, ANON_KEY);

  const vehicleSizeEl = document.getElementById("vehicleSize");
  const serviceSelectEl = document.getElementById("serviceSelect");
  const debugEl = document.getElementById("debug");
  const reloadBtn = document.getElementById("reloadBtn");
  const clearBtn = document.getElementById("clearBtn");

  function log(msg, obj) {
    const time = new Date().toLocaleTimeString();
    debugEl.textContent += `[${time}] ${msg}\n`;
    if (obj) debugEl.textContent += JSON.stringify(obj, null, 2) + "\n";
    debugEl.scrollTop = debugEl.scrollHeight;
    console.log(msg, obj ?? "");
  }

  log("Script loaded ✅");
  log("Listener attaching to #vehicleSize ✅");

  vehicleSizeEl.addEventListener("change", () => {
    log("Vehicle size changed ✅", { value: vehicleSizeEl.value });
    loadServices();
  });

  reloadBtn.addEventListener("click", () => {
    log("Reload button clicked ✅");
    loadServices();
  });

  clearBtn.addEventListener("click", () => {
    debugEl.textContent = "";
    serviceSelectEl.innerHTML = `<option value="">Select vehicle size first</option>`;
    log("Cleared debug + reset dropdown ✅");
  });

  function setDropdownOptions(rows) {
    serviceSelectEl.innerHTML = "";
    if (!rows || rows.length === 0) {
      serviceSelectEl.innerHTML = `<option value="">No services available</option>`;
      return;
    }
    serviceSelectEl.appendChild(new Option("Select a service", ""));
    rows.forEach(r => {
      const category = r.services?.category ?? "Unknown";
      const level = r.services?.level ?? "?";
      const price = r.price ?? "";
      const text = `${category} – Level ${level} ($${price})`;
      const opt = new Option(text, r.id);
      serviceSelectEl.appendChild(opt);
    });
  }

  async function loadServices() {
    const size = vehicleSizeEl.value;

    if (!size) {
      log("No size selected → not loading services");
      serviceSelectEl.innerHTML = `<option value="">Select vehicle size first</option>`;
      return;
    }

    log("Loading services for size…", { size });

    try {
      const { data, error } = await sb
        .from("service_variants")
        .select(`
          id,
          vehicle_size,
          price,
          services:service_id (
            category,
            level
          )
        `)
        .eq("vehicle_size", size)
        .eq("active", true);

      if (error) {
        log("Supabase error ❌", error);
        setDropdownOptions([]);
        return;
      }

      log("Supabase returned ✅", { count: data?.length ?? 0, sample: data?.[0] ?? null });
      setDropdownOptions(data);
    } catch (e) {
      log("Unexpected JS exception ❌", { message: e.message, stack: e.stack });
      setDropdownOptions([]);
    }
  }
</script>
</body>
</html>
