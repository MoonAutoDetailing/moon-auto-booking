<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Auto Detailing – Book a Detail</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f8fb;
      margin: 0;
      padding: 40px;
    }

    .container {
      max-width: 520px;
      background: #ffffff;
      margin: auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    h1 {
      text-align: center;
      color: #6fa8dc;
      margin-bottom: 25px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      margin-top: 25px;
      background: #6fa8dc;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background: #5c97d1;
    }

    pre {
      margin-top: 20px;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Book a Detail</h1>

  <form id="booking-form">

    <label>Full Name</label>
    <input id="full_name" required>

    <label>Email</label>
    <input id="email" type="email" required>

    <label>Phone</label>
    <input id="phone" required>

    <label>Service Address</label>
    <input id="service_address" required>

    <label>Vehicle Year</label>
    <input id="vehicle_year" required>

    <label>Vehicle Make</label>
    <input id="vehicle_make" required>

    <label>Vehicle Model</label>
    <input id="vehicle_model" required>

    <label>Vehicle Size</label>
    <select id="vehicle_size" required>
      <option value="">Select size</option>
      <option value="compact">Compact</option>
      <option value="midsized">Midsized</option>
      <option value="oversized">Oversized</option>
    </select>

    <label>License Plate</label>
    <input id="license_plate" required>

    <label>Select Service</label>
    <select id="service_variant" disabled required>
      <option value="">Select vehicle size first</option>
    </select>

    <label>Start</label>
    <input id="start" type="datetime-local" required>

    <label>End</label>
    <input id="end" type="datetime-local" required>

    <button type="submit">Submit Booking</button>
  </form>

  <pre id="result"></pre>
</div>

<script>
  const supabaseClient = window.supabase.createClient(
    "https://lhwlvleocakggpbbpzyx.supabase.co",
    "YOUR_ANON_KEY_HERE"
  );

  const vehicleSizeSelect = document.getElementById("vehicle_size");
  const serviceSelect = document.getElementById("service_variant");

  vehicleSizeSelect.addEventListener("change", async () => {
    const size = vehicleSizeSelect.value;
    serviceSelect.innerHTML = "";
    serviceSelect.disabled = true;

    if (!size) {
      serviceSelect.innerHTML = `<option>Select vehicle size first</option>`;
      return;
    }

    const { data, error } = await supabaseClient
      .from("service_variants")
      .select(`
        id,
        price,
        duration_minutes,
        services (
          category,
          level
        )
      `)
      .eq("vehicle_size", size)
      .eq("active", true);

    if (error || !data.length) {
      serviceSelect.innerHTML = `<option>No services available</option>`;
      return;
    }

    serviceSelect.disabled = false;
    serviceSelect.innerHTML = `<option value="">Select a service</option>`;

    data.forEach(variant => {
      const option = document.createElement("option");
      option.value = variant.id;
      option.textContent =
        `${variant.services.category} – Level ${variant.services.level} ` +
        `($${variant.price}, ${variant.duration_minutes} min)`;
      serviceSelect.appendChild(option);
    });
  });

  document.getElementById("booking-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const booking = {
      service_address: service_address.value,
      scheduled_start: start.value,
      scheduled_end: end.value,
      status: "pending",
      service_variant_id: serviceSelect.value
    };

    const { error } = await supabaseClient
      .from("bookings")
      .insert([booking]);

    document.getElementById("result").textContent =
      error ? error.message : "✅ Booking submitted successfully";
  });
</script>

</body>
</html>
