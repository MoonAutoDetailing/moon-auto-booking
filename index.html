<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Auto Detailing – Book Now</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --moon-blue:#4f8de6;
      --moon-blue-dark:#3e7bd6;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#d6dbe3;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .topbar{
      background:#0b0b0b;
      height:70px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding:0 18px;
    }
    .topbar img{
      height:44px;
      width:auto;
      display:block;
    }

    .wrap{
      padding:34px 16px 60px;
    }

    .card{
      max-width:560px;
      margin:0 auto;
      background:var(--card);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:28px;
    }

    h1{
      margin:0 0 22px;
      text-align:center;
      color:var(--moon-blue);
      font-size:42px;
      letter-spacing:0.2px;
    }

    label{
      display:block;
      font-weight:700;
      margin:16px 0 8px;
      font-size:15px;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:15px;
      outline:none;
      background:#fff;
    }

    input:focus, select:focus{
      border-color:var(--moon-blue);
      box-shadow:0 0 0 3px rgba(79,141,230,0.18);
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    .btn{
      border:none;
      border-radius:12px;
      padding:14px 12px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      width:100%;
      margin-top:22px;
    }
    .btn-primary{
      background:var(--moon-blue);
      color:#fff;
    }
    .btn-primary:hover{ background:var(--moon-blue-dark); }

    .status{
      margin-top:14px;
      font-size:14px;
      color:var(--muted);
      white-space:pre-wrap;
      min-height:18px;
    }

    .divider{
      height:1px;
      background:#eef2f7;
      margin:18px 0 8px;
    }

    @media (max-width:520px){
      .row{ grid-template-columns:1fr; }
      h1{ font-size:34px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <!-- Put NewLogoColor.png in the same folder as index.html -->
    <img src="NewLogoColor.png" alt="Moon Auto Detailing" />
  </div>

  <div class="wrap">
    <div class="card">
      <h1>Book a Detail</h1>

      <form id="booking-form">
        <label>Full Name</label>
        <input id="fullName" placeholder="Your name" required />

        <label>Email</label>
        <input id="email" type="email" placeholder="you@email.com" required />

        <label>Phone</label>
        <input id="phone" placeholder="(518) 555-1234" required />

        <label>Service Address</label>
        <input id="address" placeholder="Street, City, State" required />

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Vehicle Year</label>
            <input id="vehicleYear" type="number" min="1900" max="2100" placeholder="2020" required />
          </div>
          <div>
            <label>License Plate</label>
            <input id="licensePlate" placeholder="ABC123" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Vehicle Make</label>
            <input id="vehicleMake" placeholder="Toyota" required />
          </div>
          <div>
            <label>Vehicle Model</label>
            <input id="vehicleModel" placeholder="Camry" required />
          </div>
        </div>

        <!-- ✅ DO NOT TOUCH: vehicle size values are lowercase to match your DB -->
        <label>Vehicle Size</label>
        <select id="vehicleSize" required>
          <option value="">Select size</option>
          <option value="compact">compact</option>
          <option value="midsized">midsized</option>
          <option value="oversized">oversized</option>
        </select>

        <label>Select Service</label>
        <select id="serviceSelect" disabled required>
          <option value="">Select vehicle size first</option>
        </select>

        <div class="divider"></div>

        <label>Start</label>
        <input id="startTime" type="datetime-local" required />

        <label>End</label>
        <input id="endTime" type="datetime-local" required />

        <button type="submit" class="btn btn-primary">Submit Booking</button>

        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <script>
    // ✅ EXACT project details you provided (no changes)
    const supabaseClient = window.supabase.createClient(
      "https://lhwlvleocakggpbbpzyx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxod2x2bGVvY2FrZ2dwYmJwenl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTQwMDksImV4cCI6MjA4NjAzMDAwOX0.VXGGO7KCqWmcpXOFrlpPT92WmZMxe8xpNNytAsdjURI"
    );

    // Elements
    const formEl = document.getElementById("booking-form");
    const statusEl = document.getElementById("status");

    const fullNameEl = document.getElementById("fullName");
    const emailEl = document.getElementById("email");
    const phoneEl = document.getElementById("phone");
    const addressEl = document.getElementById("address");

    const vehicleYearEl = document.getElementById("vehicleYear");
    const vehicleMakeEl = document.getElementById("vehicleMake");
    const vehicleModelEl = document.getElementById("vehicleModel");
    const licensePlateEl = document.getElementById("licensePlate");
    const vehicleSizeEl = document.getElementById("vehicleSize");

    const serviceSelectEl = document.getElementById("serviceSelect");

    const startTimeEl = document.getElementById("startTime");
    const endTimeEl = document.getElementById("endTime");

    // ---------
    // SERVICES DROPDOWN (STABLE VERSION)
    // Two-step fetch: service_variants -> services (by id)
    // This avoids the flaky "services: null" join behavior entirely.
    // ---------
    vehicleSizeEl.addEventListener("change", async () => {
      await loadServicesForSize(vehicleSizeEl.value);
    });

    async function loadServicesForSize(size) {
      serviceSelectEl.disabled = true;
      serviceSelectEl.innerHTML = "";

      if (!size) {
        serviceSelectEl.innerHTML = `<option value="">Select vehicle size first</option>`;
        return;
      }

      // 1) Fetch variants for size
      const { data: variants, error: variantsErr } = await supabaseClient
        .from("service_variants")
        .select("id, service_id, price, duration_minutes")
        .eq("vehicle_size", size)
        .eq("active", true);

      if (variantsErr) {
        console.error("service_variants error:", variantsErr);
        serviceSelectEl.innerHTML = `<option value="">No services available</option>`;
        return;
      }

      if (!variants || variants.length === 0) {
        serviceSelectEl.innerHTML = `<option value="">No services available</option>`;
        return;
      }

      // 2) Fetch service metadata for those service_ids
      const serviceIds = [...new Set(variants.map(v => v.service_id).filter(Boolean))];

      const { data: services, error: servicesErr } = await supabaseClient
        .from("services")
        .select("id, category, level")
        .in("id", serviceIds);

      if (servicesErr) {
        // If this errors, you'll SEE it instead of getting silent nulls.
        console.error("services error:", servicesErr);
        serviceSelectEl.innerHTML = `<option value="">Services blocked (RLS)</option>`;
        return;
      }

      const serviceMap = new Map((services || []).map(s => [s.id, s]));

      // Build options
      serviceSelectEl.innerHTML = `<option value="">Select a service</option>`;

      // Sort for UX
      const enriched = variants.map(v => ({
        ...v,
        meta: serviceMap.get(v.service_id) || null
      }));

      enriched.sort((a,b) => {
        const ac = (a.meta?.category || "").localeCompare(b.meta?.category || "");
        if (ac !== 0) return ac;
        return (a.meta?.level || 0) - (b.meta?.level || 0);
      });

      for (const row of enriched) {
        // If meta missing, skip (don’t crash)
        if (!row.meta) continue;

        const cat = row.meta.category ?? "Service";
        const lvl = row.meta.level ?? "";
        const price = row.price ?? "";
        const mins = row.duration_minutes ?? "";

        const label = `${cat}${lvl ? " – Level " + lvl : ""} ($${price}) • ${mins} min`;

        const opt = document.createElement("option");
        opt.value = row.id; // service_variant_id
        opt.textContent = label;
        serviceSelectEl.appendChild(opt);
      }

      // If everything was skipped due to missing meta
      if (serviceSelectEl.options.length <= 1) {
        serviceSelectEl.innerHTML = `<option value="">No services available</option>`;
        serviceSelectEl.disabled = true;
        return;
      }

      serviceSelectEl.disabled = false;
    }

    // ---------
    // SUBMIT (customer -> vehicle -> booking)
    // Vehicle uses client UUID (no select)
    // ---------
    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "Submitting…";

      const full_name = fullNameEl.value.trim();
      const email = emailEl.value.trim().toLowerCase();
      const phone = phoneEl.value.trim();
      const service_address = addressEl.value.trim();

      const vehicle_year = Number(vehicleYearEl.value);
      const vehicle_make = vehicleMakeEl.value.trim();
      const vehicle_model = vehicleModelEl.value.trim();
      const vehicle_size = vehicleSizeEl.value; // lowercase
      const license_plate = licensePlateEl.value.trim();

      const service_variant_id = serviceSelectEl.value;
      const scheduled_start = startTimeEl.value;
      const scheduled_end = endTimeEl.value;

      if (!service_variant_id) {
        statusEl.textContent = "Please select a service.";
        return;
      }

      // 1) Find or create customer (requires anon select/insert on customers)
      let customerId = null;

      const { data: existingCustomers, error: findCustomerErr } = await supabaseClient
        .from("customers")
        .select("id")
        .eq("email", email)
        .limit(1);

      if (findCustomerErr) {
        console.error(findCustomerErr);
        statusEl.textContent = "Customers blocked by RLS (select).";
        return;
      }

      if (existingCustomers && existingCustomers.length > 0) {
        customerId = existingCustomers[0].id;
      } else {
        const { data: insertedCustomer, error: insertCustomerErr } = await supabaseClient
          .from("customers")
          .insert([{
            full_name,
            email,
            phone,
            address: service_address
          }])
          .select("id")
          .single();

        if (insertCustomerErr) {
          console.error(insertCustomerErr);
          statusEl.textContent = "Error creating customer: " + insertCustomerErr.message;
          return;
        }

        customerId = insertedCustomer.id;
      }

      // 2) Create vehicle with client UUID (NO select)
      const vehicleId = crypto.randomUUID();

      const { error: insertVehicleErr } = await supabaseClient
        .from("vehicles")
        .insert([{
          id: vehicleId,
          customer_id: customerId,
          vehicle_size,
          license_plate,
          vehicle_year,
          vehicle_make,
          vehicle_model
        }]); // <-- NO .select()

      if (insertVehicleErr) {
        console.error(insertVehicleErr);
        statusEl.textContent = "Error creating vehicle: " + insertVehicleErr.message;
        return;
      }

      // 3) Create booking using known vehicleId (NO select)
      const { error: insertBookingErr } = await supabaseClient
        .from("bookings")
        .insert([{
          customer_id: customerId,
          vehicle_id: vehicleId,
          service_variant_id,
          service_address,
          scheduled_start,
          scheduled_end,
          status: "pending"
        }]); // <-- NO .select()

      if (insertBookingErr) {
        console.error(insertBookingErr);
        statusEl.textContent = "Error creating booking: " + insertBookingErr.message;
        return;
      }

      statusEl.textContent = "✅ Booking submitted successfully.";
      formEl.reset();
      serviceSelectEl.disabled = true;
      serviceSelectEl.innerHTML = `<option value="">Select vehicle size first</option>`;
    });
  </script>
</body>
</html>
